<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pemetaan Data Dapodik - SMPN 1 Moga</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>ğŸ“Š Pemetaan Data Dapodik</h1>
    <p>Unggah file Excel Dapodik Anda untuk memisahkan data per rombel</p>

    <div class="upload-section">
      <input type="file" id="excelFile" accept=".xlsx, .xls">
      <button id="loadBtn">ğŸ“‚ Muat Data</button>
    </div>

    <div class="filter-section" style="display:none;">
      <label for="rombelSelect">Pilih Rombel:</label>
      <select id="rombelSelect"></select>
      <button id="processBtn">ğŸ” Proses</button>
      <button id="downloadBtn">ğŸ’¾ Download Excel</button>
    </div>

    <div class="table-container">
      <table id="dataTable">
        <thead id="tableHead"></thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </div>

  <script>
    let allData = [];

    document.getElementById('loadBtn').addEventListener('click', () => {
      const fileInput = document.getElementById('excelFile');
      if (!fileInput.files.length) return alert('Pilih file Excel terlebih dahulu!');
      const reader = new FileReader();
      reader.onload = (e) => {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(sheet, { range: 4 }); // lewati 4 header
        allData = json;

        const rombelCol = "Rombel Saat Ini_Unnamed: 42_level_1";
        const rombelList = [...new Set(allData.map(row => row[rombelCol]).filter(v => v))];

        const rombelSelect = document.getElementById('rombelSelect');
        rombelSelect.innerHTML = '<option value="">-- Pilih Rombel --</option>';
        rombelList.forEach(r => {
          const opt = document.createElement('option');
          opt.value = r;
          opt.textContent = r;
          rombelSelect.appendChild(opt);
        });

        document.querySelector('.filter-section').style.display = 'flex';
        alert('File berhasil dimuat! Silakan pilih rombel.');
      };
      reader.readAsArrayBuffer(fileInput.files[0]);
    });

    document.getElementById('processBtn').addEventListener('click', () => {
      const rombelCol = "Rombel Saat Ini_Unnamed: 42_level_1";
      const selectedRombel = document.getElementById('rombelSelect').value;
      if (!selectedRombel) return alert('Pilih rombel terlebih dahulu!');
      const filtered = allData.filter(row => row[rombelCol] === selectedRombel);
      renderTable(filtered);
    });

    function renderTable(data) {
      const head = document.getElementById('tableHead');
      const body = document.getElementById('tableBody');
      head.innerHTML = ''; body.innerHTML = '';

      if (!data.length) return alert('Tidak ada data untuk rombel ini!');
      const headers = Object.keys(data[0]);

      const headerRow = document.createElement('tr');
      headers.forEach(h => {
        const th = document.createElement('th');
        th.textContent = h;
        headerRow.appendChild(th);
      });
      head.appendChild(headerRow);

      data.forEach(row => {
        const tr = document.createElement('tr');
        headers.forEach(h => {
          const td = document.createElement('td');
          td.textContent = row[h] || '';
          tr.appendChild(td);
        });
        body.appendChild(tr);
      });
    }

    document.getElementById('downloadBtn').addEventListener('click', () => {
      const table = document.getElementById('dataTable');
      if (!table.rows.length) return alert('Tidak ada data untuk diunduh!');
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.table_to_sheet(table);
      XLSX.utils.book_append_sheet(wb, ws, 'Filtered');
      XLSX.writeFile(wb, 'Data_Rombel.xlsx');
    });
  </script>
</body>
</html>
