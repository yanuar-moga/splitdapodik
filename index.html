<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Filter Data Dapodik per Rombel</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: "Poppins", sans-serif;
      background: #f3f4f6;
      padding: 20px;
      color: #333;
    }
    h2 {
      text-align: center;
      margin-bottom: 20px;
      color: #2c3e50;
    }
    .card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      max-width: 1000px;
      margin: 0 auto;
    }
    input, select, button {
      margin: 10px 0;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    button {
      background-color: #0078ff;
      color: white;
      border: none;
      cursor: pointer;
      transition: 0.3s;
    }
    button:hover {
      background-color: #005fcc;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    table th, table td {
      border: 1px solid #ddd;
      padding: 6px;
      text-align: left;
      font-size: 13px;
    }
    table th {
      background: #0078ff;
      color: white;
    }
  </style>
</head>
<body>
  <h2>ðŸ“Š Aplikasi Filter Data Dapodik per Rombel</h2>
  <div class="card">
    <input type="file" id="inputExcel" accept=".xlsx,.xls" />
    <br>
    <label for="rombelSelect"><b>Pilih Rombel:</b></label>
    <select id="rombelSelect"></select>
    <button id="btnFilter">Proses Filter</button>
    <button id="btnDownload">Download Excel</button>

    <div id="tableContainer"></div>
  </div>

  <script>
    let allData = [];
    let filteredData = [];

    document.getElementById('inputExcel').addEventListener('change', handleFile, false);
    document.getElementById('btnFilter').addEventListener('click', filterData);
    document.getElementById('btnDownload').addEventListener('click', downloadExcel);

    function handleFile(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (event) {
        const data = new Uint8Array(event.target.result);
        const workbook = XLSX.read(data, { type: 'array' });

        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });

        // Lewati 4 baris header
        const headers = json[4];
        const rows = json.slice(5);

        allData = rows.map(row => {
          let obj = {};
          headers.forEach((h, i) => {
            obj[h] = row[i];
          });
          return obj;
        });

        // Deteksi kolom Rombel otomatis
        const rombelCol = headers.find(h => h.toLowerCase().includes("rombel"));
        const rombelList = [...new Set(allData.map(d => d[rombelCol]).filter(Boolean))];

        // Isi dropdown
        const select = document.getElementById('rombelSelect');
        select.innerHTML = rombelList.map(r => `<option value="${r}">${r}</option>`).join('');

        alert("File Excel berhasil dimuat âœ…. Ditemukan " + rombelList.length + " rombel.");
      };
      reader.readAsArrayBuffer(file);
    }

    function filterData() {
      const rombel = document.getElementById('rombelSelect').value;
      if (!rombel) {
        alert("Pilih rombel terlebih dahulu!");
        return;
      }

      const rombelCol = Object.keys(allData[0]).find(h => h.toLowerCase().includes("rombel"));
      filteredData = allData.filter(d => d[rombelCol] === rombel);

      renderTable(filteredData);
    }

    function renderTable(data) {
      if (!data.length) {
        document.getElementById('tableContainer').innerHTML = "<p>Tidak ada data untuk ditampilkan.</p>";
        return;
      }

      const headers = Object.keys(data[0]);
      let html = "<table><thead><tr>";
      headers.forEach(h => html += `<th>${h}</th>`);
      html += "</tr></thead><tbody>";

      data.forEach(row => {
        html += "<tr>";
        headers.forEach(h => html += `<td>${row[h] || ""}</td>`);
        html += "</tr>";
      });

      html += "</tbody></table>";
      document.getElementById('tableContainer').innerHTML = html;
    }

    function downloadExcel() {
      if (!filteredData.length) {
        alert("Filter data dulu sebelum download!");
        return;
      }

      const ws = XLSX.utils.json_to_sheet(filteredData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Data Rombel");
      XLSX.writeFile(wb, `Data_${document.getElementById('rombelSelect').value}.xlsx`);
    }
  </script>
</body>
</html>
