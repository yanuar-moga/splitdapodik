<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pemetaan Dapodik Otomatis</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>📘 Pemetaan Data Dapodik Otomatis</h1>
    <p>Unggah file Excel Dapodik Anda (dengan 4 header sebelum tabel data).</p>

    <div class="upload-section">
      <input type="file" id="excelFile" accept=".xlsx,.xls">
      <button id="loadBtn">📂 Muat Data</button>
    </div>

    <div id="rombelList" class="rombel-list"></div>

    <div id="tableSection" style="display:none;">
      <h2 id="rombelTitle"></h2>
      <button id="downloadBtn">💾 Download Excel Rombel Ini</button>
      <div class="table-container">
        <table id="dataTable">
          <thead id="tableHead"></thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    let allData = [];
    let filteredData = [];
    let rombelColumn = null;

    document.getElementById('loadBtn').addEventListener('click', () => {
      const fileInput = document.getElementById('excelFile');
      if (!fileInput.files.length) return alert('Pilih file Excel terlebih dahulu!');
      const reader = new FileReader();

      reader.onload = (e) => {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];

        // Lewati 4 baris pertama (header Dapodik)
        const json = XLSX.utils.sheet_to_json(sheet, { range: 4 });
        allData = json;

        if (allData.length === 0) {
          alert('Tidak ada data yang bisa dibaca dari file ini.');
          return;
        }

        // 🔍 Deteksi otomatis kolom yang mengandung kata "Rombel"
        const headers = Object.keys(allData[0]);
        rombelColumn = headers.find(h => h.toLowerCase().includes("rombel"));

        if (!rombelColumn) {
          alert('Kolom rombel tidak ditemukan! Pastikan file Dapodik benar.');
          return;
        }

        // Dapatkan daftar rombel unik
        const rombelList = [...new Set(allData.map(r => r[rombelColumn]).filter(Boolean))];
        tampilkanDaftarRombel(rombelList);
      };

      reader.readAsArrayBuffer(fileInput.files[0]);
    });

    function tampilkanDaftarRombel(list) {
      const container = document.getElementById('rombelList');
      container.innerHTML = '<h2>📋 Daftar Rombel</h2>';

      if (list.length === 0) {
        container.innerHTML += '<p>Tidak ditemukan data rombel di file Excel.</p>';
        return;
      }

      list.forEach(rombel => {
        const card = document.createElement('div');
        card.className = 'rombel-card';
        card.innerHTML = `
          <h3>${rombel}</h3>
          <button class="lihatBtn" data-rombel="${rombel}">Lihat Data</button>
        `;
        container.appendChild(card);
      });

      document.querySelectorAll('.lihatBtn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const selected = e.target.getAttribute('data-rombel');
          tampilkanTabelRombel(selected);
        });
      });
    }

    function tampilkanTabelRombel(rombel) {
      filteredData = allData.filter(row => row[rombelColumn] === rombel);
      if (!filteredData.length) return alert('Tidak ada data untuk rombel ini.');

      const head = document.getElementById('tableHead');
      const body = document.getElementById('tableBody');
      const title = document.getElementById('rombelTitle');
      const section = document.getElementById('tableSection');

      title.textContent = `📊 Data Rombel: ${rombel}`;
      head.innerHTML = ''; body.innerHTML = '';
      section.style.display = 'block';

      const headers = Object.keys(filteredData[0]);
      const trHead = document.createElement('tr');
      headers.forEach(h => {
        const th = document.createElement('th');
        th.textContent = h;
        trHead.appendChild(th);
      });
      head.appendChild(trHead);

      filteredData.forEach(row => {
        const tr = document.createElement('tr');
        headers.forEach(h => {
          const td = document.createElement('td');
          td.textContent = row[h] || '';
          tr.appendChild(td);
        });
        body.appendChild(tr);
      });
    }

    document.getElementById('downloadBtn').addEventListener('click', () => {
      if (!filteredData.length) return alert('Tidak ada data yang bisa diunduh.');
      const ws = XLSX.utils.json_to_sheet(filteredData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Rombel');
      const namaFile = `Data_${document.getElementById('rombelTitle').textContent.replace("📊 Data Rombel: ", "")}.xlsx`;
      XLSX.writeFile(wb, namaFile);
    });
  </script>
</body>
</html>
