<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Analisis Nilai & Link Perbaikan</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; background: #f9f9f9; }
  h2 { color: #333; }
  textarea { width: 100%; height: 300px; margin-top: 10px; font-family: monospace; }
  button { margin-top: 10px; padding: 8px 14px; background: #0078d7; color: white; border: none; border-radius: 6px; cursor: pointer; }
  button:hover { background: #005fa3; }
</style>
</head>
<body>

<h2>üìä Analisis Nilai Siswa</h2>

<input type="file" id="excelFile" accept=".xlsx, .xls">
<br><br>
<label>Masukkan KKM: </label>
<input type="number" id="kkm" value="75" min="0" max="100">
<br><br>

<div id="sheetSelectContainer"></div>
<div id="tpCheckboxContainer"></div>

<br>
<button onclick="analyzeData()">Analisis Data</button>

<h3>üì± Hasil Teks WhatsApp</h3>
<textarea id="waText" readonly></textarea>
<br>
<button onclick="copyToClipboard()">üìã Salin Teks WhatsApp</button>

<script>
let workbook;
let selectedSheetName = "";

document.getElementById("excelFile").addEventListener("change", handleFile, false);

function handleFile(e) {
  const reader = new FileReader();
  reader.onload = function (e) {
    const data = new Uint8Array(e.target.result);
    workbook = XLSX.read(data, { type: "array" });
    const sheetNames = workbook.SheetNames;

    // Dropdown pilih sheet
    const selectHTML = `
      <label>Pilih Sheet: </label>
      <select id="sheetSelect">
        ${sheetNames.map(name => `<option value="${name}">${name}</option>`).join("")}
      </select>
    `;
    document.getElementById("sheetSelectContainer").innerHTML = selectHTML;

    // Checkbox TP (BAB 3-5)
    const tpHTML = `
      <label>Pilih TP untuk dicek:</label><br>
      ${[3, 4, 5].map(bab => 
        Array.from({length: 4}, (_, i) => 
          `<label><input type="checkbox" value="BAB ${bab} TP ${i+1}" checked> BAB ${bab} TP ${i+1}</label><br>`
        ).join("")
      ).join("")}
    `;
    document.getElementById("tpCheckboxContainer").innerHTML = tpHTML;
  };
  reader.readAsArrayBuffer(e.target.files[0]);
}

function analyzeData() {
  selectedSheetName = document.getElementById("sheetSelect").value;
  const sheet = workbook.Sheets[selectedSheetName];
  const kkm = parseFloat(document.getElementById("kkm").value);
  const selectedTP = Array.from(document.querySelectorAll("#tpCheckboxContainer input:checked")).map(cb => cb.value);
  const data = XLSX.utils.sheet_to_json(sheet, { header: 1 });

  const results = [];
  const waMap = {}; // menyimpan data per siswa

  for (let i = 9; i < data.length; i++) {
    const row = data[i];
    const nama = row[1];
    if (!nama) break;

    const nilaiTP = row.slice(2, 22);
    const detail = {};
    const perbaikan = [];

    selectedTP.forEach(label => {
      const [bab, tp] = label.match(/BAB (\\d) TP (\\d)/).slice(1).map(Number);
      const colIndex = (bab - 1) * 4 + (tp - 1);
      const nilai = parseFloat(nilaiTP[colIndex]);

      if (isNaN(nilai) || nilai < kkm) {
        detail[label] = nilai || "";
        perbaikan.push(label);
      }
    });

    if (perbaikan.length > 0) {
      results.push({ nama, ...detail });

      perbaikan.forEach(tp => {
        let link = "";
        if (tp.includes("BAB 3")) link = "https://look.short.gy/asesmenbab3";
        else if (tp.includes("BAB 4")) link = "https://look.short.gy/asesmenbab4";
        else if (tp.includes("BAB 5")) link = "https://look.short.gy/asesmenbab5";

        if (!waMap[nama]) waMap[nama] = [];
        waMap[nama].push(`- ${tp} ‚Üí link perbaikan: ${link}`);
      });
    }
  }

  // üîπ Urutkan berdasarkan nama siswa
  const sortedNames = Object.keys(waMap).sort((a, b) => a.localeCompare(b, "id"));

  // üîπ Buat teks WhatsApp rapi
  let waText = "Berikut daftar siswa yang perlu perbaikan nilai:\n\n";
  sortedNames.forEach((nama, index) => {
    waText += `${index + 1}. ${nama.toUpperCase()}\n`;
    waText += waMap[nama].join("\n") + "\n\n";
  });

  if (sortedNames.length === 0) {
    waText = "Semua siswa sudah tuntas. üëç";
  }

  document.getElementById("waText").value = waText.trim();
}

// üîπ Fungsi salin teks ke clipboard
function copyToClipboard() {
  const textarea = document.getElementById("waText");
  textarea.select();
  document.execCommand("copy");
  alert("‚úÖ Teks WhatsApp berhasil disalin ke clipboard!");
}
</script>

</body>
</html>
