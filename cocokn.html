<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Rekap Nilai Siswa - Versi Lengkap</title>

<!-- SheetJS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<!-- Fuse.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.6.2/fuse.min.js"></script>

<style>
    body { font-family: Arial; padding: 20px; background: #f2f4f7; }
    .box {
        background: white; padding: 20px; border-radius: 10px; width: 750px;
        box-shadow: 0 3px 10px rgba(0,0,0,0.1); margin-bottom: 20px;
    }
    h2 { margin-top: 0; }
    input[type=file], input[type=number] {
        width: 100%; padding: 10px; margin: 8px 0; border-radius: 6px; border: 1px solid #aaa;
    }
    button {
        padding: 12px 20px; background: #0078d7; color: white; border: none;
        border-radius: 6px; cursor: pointer; width: 100%; font-size: 15px;
    }
    button:hover { background: #005fa3; }
    #progress { width: 100%; height: 22px; background: #e0e0e0; border-radius: 6px; margin-top: 12px; }
    #bar { width: 0%; height: 100%; background: #4caf50; border-radius: 6px; }
    #status { margin-top: 10px; font-weight: bold; }

    #output { margin-top: 20px; }
    table { border-collapse: collapse; width: 100%; background: white; }
    th, td { border: 1px solid #666; padding: 6px; text-align: center; }
    th { background: #ddd; }
</style>
</head>
<body>

<!-- Header -->
<div style="display:flex; align-items:center; gap:15px; margin-bottom:20px;">
    <img src="assets/logo.jpg" style="width:80px; height:auto; border-radius:8px;">
    <div>
        <h2 style="margin:0;">Rekap Nilai Siswa</h2>
        <small>Versi 1.0 (Build 14 November 2025) ‚Äî Dev by MB</small>
    </div>
</div>

<div class="box">
    <label>üìÑ File Respons:</label>
    <input type="file" id="fileResp" accept=".xlsx,.xls">

    <label>üìò File Daftar Siswa:</label>
    <input type="file" id="fileSiswa" accept=".xlsx,.xls">

    <label>üéØ Nilai KKM:</label>
    <input type="number" id="kkm" placeholder="contoh: 70">

    <button onclick="proses()">‚öôÔ∏è PROSES DATA</button>

    <div id="progress"><div id="bar"></div></div>
    <p id="status">Menunggu perintah...</p>
</div>

<div id="output"></div>

<script>
function setProgress(p) {
    document.getElementById("bar").style.width = p + "%";
}

function readExcel(file) {
    return new Promise((resolve) => {
        const fr = new FileReader();
        fr.onload = (e) => {
            const data = new Uint8Array(e.target.result);
            const wb = XLSX.read(data, {type: 'array'});
            const ws = wb.Sheets[wb.SheetNames[0]];
            resolve(XLSX.utils.sheet_to_json(ws, {defval:""}));
        };
        fr.readAsArrayBuffer(file);
    });
}

function nilaiAkhir(arr) {
    if (!arr || arr.length === 0) return "";
    return Math.max(...arr);
}

// pewarnaan sel
function setCellColor(cell, color) {
    cell.s = {
        fill: { patternType: "solid", fgColor: { rgb: color } }
    };
}

async function proses() {

    let fileResp = document.getElementById("fileResp").files[0];
    let fileSiswa = document.getElementById("fileSiswa").files[0];
    let kkm = parseFloat(document.getElementById("kkm").value);

    if (!fileResp || !fileSiswa || isNaN(kkm)) {
        alert("Lengkapi semua input!");
        return;
    }

    setProgress(10);
    document.getElementById("status").innerText = "üìò Membaca file...";

    let resp = await readExcel(fileResp);
    let siswa = await readExcel(fileSiswa);

    // Normalisasi nama
    resp.forEach(r => r._nama = (r.NAMA || r.Nama || "").toString().toLowerCase().trim());
    siswa.forEach(s => s._nama = (s.NAMA || s.Nama || "").toString().toLowerCase().trim());

    setProgress(20);
    document.getElementById("status").innerText = "üîç Menjalankan fuzzy matching...";

    let fuse = new Fuse(resp, { keys:["_nama"], threshold:0.3 });

    let hasil = [];
    let maxScores = 0;
    let idx = 1;

    setProgress(30);

    for (let s of siswa) {

        let match = fuse.search(s._nama);
        let scoreList = [];

        if (match.length > 0) {
            let row = match[0].item;

            // ambil kolom score dinamis
            for (let k in row) {
                let lk = k.toLowerCase();
                if (lk.includes("score") || lk.includes("nilai") || lk.includes("skor")) {
                    let v = parseFloat(row[k]);
                    if (!isNaN(v)) scoreList.push(v);
                }
            }
        }

        if (scoreList.length > maxScores) maxScores = scoreList.length;

        hasil.push({
            NO: idx++,
            NAMA: s.NAMA || s.Nama,
            NILAI_AKHIR: nilaiAkhir(scoreList),
            SCORES: scoreList
        });

        setProgress(30 + (idx / siswa.length) * 60);
    }

    document.getElementById("status").innerText = "üìä Membuat tabel output...";

    // ====================
    // TABEL HTML
    // ====================
    let html = "<table><tr><th>NO</th><th>NAMA</th><th>NILAI AKHIR</th>";

    for (let i=1; i<=maxScores; i++) html += `<th>SCORE${i}</th>`;
    html += "</tr>";

    hasil.forEach(r => {
        html += `<tr>
            <td>${r.NO}</td>
            <td>${r.NAMA}</td>
            <td>${r.NILAI_AKHIR}</td>
        `;

        for (let i=0; i<maxScores; i++) {
            html += `<td>${r.SCORES[i] ?? ""}</td>`;
        }

        html += "</tr>";
    });

    html += "</table>";

    document.getElementById("output").innerHTML = html;

    // ====================
    // EXCEL EXPORT
    // ====================
    document.getElementById("status").innerText = "üì¶ Membuat Excel...";

    // siapkan JSON untuk XLSX
    let exportData = hasil.map(r => {
        let obj = { NO: r.NO, NAMA: r.NAMA, NILAI_AKHIR: r.NILAI_AKHIR };
        r.SCORES.forEach((v, idx) => { obj[`SCORE${idx+1}`] = v; });
        return obj;
    });

    let ws = XLSX.utils.json_to_sheet(exportData);
    let wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "HASIL");

    // warnai cell
    let range = XLSX.utils.decode_range(ws["!ref"]);
    for (let R = range.s.r + 1; R <= range.e.r; R++) {

        let nilai = ws[XLSX.utils.encode_cell({r:R, c:2})]?.v;

        if (nilai !== "" && nilai !== undefined) {
            let color = "F8CBAD"; // merah
            if (nilai > kkm) color = "C6EFCE"; // hijau
            else if (nilai == kkm) color = "FFF2CC"; // kuning

            setCellColor(ws[XLSX.utils.encode_cell({r:R, c:2})], color);
        }
    }

    XLSX.writeFile(wb, "REKAP_NILAI_FINAL.xlsx");

    setProgress(100);
    document.getElementById("status").innerText = "‚úÖ Selesai! File sudah dibuat.";
}
</script>

</body>
</html>
