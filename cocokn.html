<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Rekap Nilai Siswa</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
    body {
        font-family: Arial, sans-serif;
        padding: 20px;
        background: #f2f2f2;
    }
    h1 {
        margin-bottom: 0px;
    }
    .header-box {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 30px;
    }
    .header-box img {
        width: 70px;
        height: 70px;
        border-radius: 10px;
        border: 2px solid #ddd;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 25px;
        background: #fff;
    }
    table, th, td {
        border: 1px solid #aaa;
    }
    th, td {
        padding: 8px;
        text-align: center;
    }
    th {
        background: #444;
        color: #fff;
    }
    .green { background: #b6f7b6 !important; }
    .yellow { background: #fff6a3 !important; }
    .red { background: #ffb3b3 !important; }
</style>
</head>
<body>

<div class="header-box">
    <img src="asset/logo.jpg" alt="Logo">
    <div>
        <h1>Rekap Nilai Siswa</h1>
        <div>Versi 1.0 (Build 14 November 2025) â€” Dev by MB</div>
    </div>
</div>

<label>KKM: <input type="number" id="kkm" value="78"></label>
<br><br>

<h3>Upload Daftar Siswa (Kolom A=NO, B=Nama, C=Score)</h3>
<input type="file" id="fileDaftar" accept=".xlsx, .xls">

<h3>Upload Respons Nilai (B=Score, C=Nama, D=Absen, E=Kelas)</h3>
<input type="file" id="fileRespons" accept=".xlsx, .xls">

<div id="output"></div>

<script>
let daftarSiswa = [];
let responsNilai = [];
let hasilGabung = [];

function bacaExcel(file, callback) {
    const reader = new FileReader();
    reader.onload = (e) => {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: "array" });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });
        callback(json);
    };
    reader.readAsArrayBuffer(file);
}

document.getElementById("fileDaftar").addEventListener("change", function() {
    bacaExcel(this.files[0], (rows) => {

        rows = rows.slice(1); // skip header

        daftarSiswa = rows
            .filter(r => r[1]) // hanya yang punya nama
            .map(r => ({
                no: r[0],
                nama: r[1].toString().trim(),
                scores: []  // akan diisi dari respons
            }));

        alert("Daftar siswa berhasil dimuat!");
        cobaGabung();
    });
});

document.getElementById("fileRespons").addEventListener("change", function() {
    bacaExcel(this.files[0], (rows) => {

        rows = rows.slice(1); // skip header

        responsNilai = rows
            .filter(r => r[2]) // hanya baris dengan nama
            .map(r => ({
                score: Number(r[1]),
                nama: r[2].toString().trim(),
                absen: r[3],
                kelas: r[4]
            }));

        alert("Respons nilai berhasil dimuat!");
        cobaGabung();
    });
});

function cobaGabung() {
    if (daftarSiswa.length === 0 || responsNilai.length === 0) return;

    let mapScore = {};

    responsNilai.forEach(r => {
        if (!mapScore[r.nama]) mapScore[r.nama] = [];
        mapScore[r.nama].push(r.score);
    });

    hasilGabung = daftarSiswa.map(s => {
        let scores = mapScore[s.nama] || [];
        let nilaiAkhir = scores.length > 0 ? Math.max(...scores) : "";

        return {
            no: s.no,
            nama: s.nama,
            nilaiAkhir: nilaiAkhir,
            scores: scores
        };
    });

    tampilkanTabel();
}

function tampilkanTabel() {
    const kkm = Number(document.getElementById("kkm").value);
    let maxScoreCount = Math.max(...hasilGabung.map(s => s.scores.length));

    let html = "<table><tr>";
    html += "<th>No</th><th>Nama Siswa</th><th>Nilai Akhir</th>";

    for (let i = 1; i <= maxScoreCount; i++) {
        html += `<th>Score ${i}</th>`;
    }
    html += "</tr>";

    hasilGabung.forEach(s => {
        html += "<tr>";
        html += `<td>${s.no}</td>`;
        html += `<td>${s.nama}</td>`;

        let warnaNA = s.nilaiAkhir === "" ? "" :
                      s.nilaiAkhir > kkm ? "green" :
                      s.nilaiAkhir == kkm ? "yellow" : "red";

        html += `<td class="${warnaNA}">${s.nilaiAkhir}</td>`;

        for (let i = 0; i < maxScoreCount; i++) {
            let sc = s.scores[i] ?? "";
            let warna = "";

            if (sc !== "") {
                warna = sc > kkm ? "green" :
                        sc == kkm ? "yellow" : "red";
            }

            html += `<td class="${warna}">${sc}</td>`;
        }

        html += "</tr>";
    });

    html += "</table>";
    document.getElementById("output").innerHTML = html;
}
</script>

</body>
</html>
