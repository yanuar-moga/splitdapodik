<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Rekap Nilai Siswa - Versi Lengkap</title>

<!-- SheetJS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<!-- Fuse.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.6.2/fuse.min.js"></script>

<style>
    body { font-family: Arial; padding: 20px; background: #f2f4f7; }
    .box {
        background: white; padding: 20px; border-radius: 10px; width: 750px;
        box-shadow: 0 3px 10px rgba(0,0,0,0.1); margin-bottom: 25px;
    }
    h2 { margin-top: 0; }
    input[type=file], input[type=number] {
        width: 100%; padding: 10px; margin: 8px 0; border-radius: 6px; border: 1px solid #aaa;
    }
    button {
        padding: 12px 20px; background: #0078d7; color: white; border: none;
        border-radius: 6px; cursor: pointer; width: 100%; font-size: 15px;
    }
    button:hover { background: #005fa3; }
    #progress { width: 100%; height: 22px; background: #e0e0e0; border-radius: 6px; margin-top: 12px; }
    #bar { width: 0%; height: 100%; background: #4caf50; border-radius: 6px; }
    #status { margin-top: 10px; font-weight: bold; }

    table { border-collapse: collapse; margin-top: 20px; width: 100%; background: white; }
    th, td { border: 1px solid #999; padding: 6px; text-align: center; }
    th { background: #0078d7; color: white; }
</style>
</head>
<body>

<div style="display:flex; align-items:center; gap:20px; margin-bottom:20px;">
    <img src="asset/logo.jpg" style="height:80px; border-radius:8px;">
    <div>
        <h2 style="margin:0;">Rekap Nilai Siswa</h2>
        <div>Versi 1.0 (Build 14 November 2025)</div>
        <div>Dev by MB</div>
    </div>
</div>

<div class="box">
    <label>üìÑ File Respons (berisi nilai siswa):</label>
    <input type="file" id="fileResp" accept=".xlsx,.xls">

    <label>üìò File Daftar Siswa (Nama Siswa):</label>
    <input type="file" id="fileSiswa" accept=".xlsx,.xls">

    <label>üéØ Nilai KKM:</label>
    <input type="number" id="kkm" value="78">

    <button onclick="proses()">‚öôÔ∏è PROSES DATA</button>

    <div id="progress"><div id="bar"></div></div>
    <p id="status">Menunggu perintah...</p>
</div>

<h3>üìä Hasil Rekap</h3>
<div id="tabelHasil"></div>

<script>
function setProgress(p) {
    document.getElementById("bar").style.width = p + "%";
}

function readExcel(file) {
    return new Promise((resolve) => {
        const fr = new FileReader();
        fr.onload = (e) => {
            const data = new Uint8Array(e.target.result);
            const wb = XLSX.read(data, { type: 'array' });
            const ws = wb.Sheets[wb.SheetNames[0]];
            resolve(XLSX.utils.sheet_to_json(ws, { defval: "" }));
        };
        fr.readAsArrayBuffer(file);
    });
}

// Nilai tertinggi
function nilaiAkhir(arr) {
    if (!arr || arr.length === 0) return "";
    return Math.max(...arr);
}

// Warna sel
function warnaSel(cell, color) {
    cell.s = {
        fill: { patternType: "solid", fgColor: { rgb: color } }
    };
}

async function proses() {

    let fileResp = document.getElementById("fileResp").files[0];
    let fileSiswa = document.getElementById("fileSiswa").files[0];
    let kkm = parseFloat(document.getElementById("kkm").value);

    if (!fileResp || !fileSiswa) {
        alert("File belum dipilih!");
        return;
    }

    document.getElementById("status").innerText = "üìò Membaca file...";
    setProgress(15);

    let resp = await readExcel(fileResp);
    let siswa = await readExcel(fileSiswa);

    // Normalisasi nama
    resp.forEach(r => r._nama = (r.NAMA || r.Nama || r["Nama Siswa"] || "").toString().toLowerCase().trim());
    siswa.forEach(s => s._nama = (s.NAMA || s.Nama || s["Nama Siswa"] || "").toString().toLowerCase().trim());

    setProgress(25);

    let fuse = new Fuse(resp, { keys: ["_nama"], threshold: 0.3 });

    let hasil = [];
    let idx = 1;

    document.getElementById("status").innerText = "üîÑ Memproses data...";

    for (let s of siswa) {

        let match = fuse.search(s._nama);

        let scores = [];
        let rowMatch = match.length > 0 ? match[0].item : {};

        // Ambil nilai score otomatis
        for (let k in rowMatch) {
            let key = k.toLowerCase();
            if (key.includes("score") || key.includes("nilai")) {
                let v = parseFloat(rowMatch[k]);
                if (!isNaN(v)) scores.push(v);
            }
        }

        let nilaiAkh = nilaiAkhir(scores);

        let obj = {
            NO: idx++,
            "NAMA SISWA": s.NAMA || s.Nama || s["Nama Siswa"],
            "NILAI AKHIR": nilaiAkh
        };

        scores.forEach((v, i) => obj["SCORE" + (i + 1)] = v);

        hasil.push(obj);

        setProgress(25 + (idx / siswa.length) * 60);
    }

    document.getElementById("status").innerText = "üìä Membuat tabel...";

    // -------------------------
    // TAMPILKAN TABEL HTML
    // -------------------------
    let html = "<table><tr>";
    Object.keys(hasil[0]).forEach(k => html += "<th>" + k + "</th>");
    html += "</tr>";

    hasil.forEach(r => {
        html += "<tr>";
        Object.values(r).forEach(v => html += "<td>" + v + "</td>");
        html += "</tr>";
    });

    html += "</table>";
    document.getElementById("tabelHasil").innerHTML = html;

    // -------------------------
    // BUAT FILE EXCEL
    // -------------------------
    document.getElementById("status").innerText = "üì¶ Membuat Excel...";

    const ws = XLSX.utils.json_to_sheet(hasil);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "HASIL");

    const range = XLSX.utils.decode_range(ws["!ref"]);

    for (let R = range.s.r + 1; R <= range.e.r; R++) {
        let val = ws[XLSX.utils.encode_cell({ r: R, c: 2 })]?.v;

        if (val !== undefined && val !== "") {
            let color = "F8CBAD"; // merah
            if (val > kkm) color = "C6EFCE"; // hijau
            else if (val == kkm) color = "FFF2CC"; // kuning

            warnaSel(ws[XLSX.utils.encode_cell({ r: R, c: 2 })], color);
        }
    }

    XLSX.writeFile(wb, "REKAP_NILAI_FINAL.xlsx");

    setProgress(100);
    document.getElementById("status").innerText = "‚úÖ Selesai! File Excel berhasil dibuat.";
}
</script>

</body>
</html>
