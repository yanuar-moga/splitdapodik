<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Rekap Nilai Siswa</title>

<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

<style>
  body { font-family: Arial, sans-serif; padding: 20px; }
  select, button { padding: 8px 14px; margin: 6px 0; }
  table { border-collapse: collapse; width: 100%; margin-top: 20px; }
  table, th, td { border: 1px solid #ccc; }
  th { background:#f5f5f5; }
  th, td { padding: 8px; text-align:left; }
  #kelasMenu { margin-top: 20px; }
</style>
</head>

<body>

<h2>ðŸ“Š Rekap Nilai Siswa</h2>

<div id="kelasMenu">
  <label><b>Pilih Kelas:</b></label>
  <select id="pilihKelas" onchange="filterKelas()">
    <option value="ALL">Semua Kelas</option>
  </select>
</div>

<div id="tableDiv">Memuat data...</div>

<div id="downloadArea" style="margin-top:20px; display:none;">
  <h3>ðŸ“¥ Download Rekapan</h3>
  <button onclick="downloadExcel()">Download Excel</button>
  <button onclick="downloadPDF()">Download PDF</button>
</div>

<script>
// === KONFIGURASI GOOGLE SHEET ===
const sheetID = "MASUKKAN_ID_GOOGLE_SHEET_DI_SINI";  
const sheetName = "Sheet1";  

let globalData = null;

google.charts.load('current', {'packages':['table']});
google.charts.setOnLoadCallback(loadSheetData);

function loadSheetData() {
    const query = new google.visualization.Query(
        `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?sheet=${sheetName}`
    );

    query.send(response => {
        if (response.isError()) {
            document.getElementById("tableDiv").innerHTML = "Gagal memuat data.";
            return;
        }

        globalData = response.getDataTable();
        tampilkanKelas(globalData);
        tampilkanTabel(globalData);
    });
}

function tampilkanKelas(data) {
    const pilih = document.getElementById("pilihKelas");
    const kelasSet = new Set();

    // Cari kolom bernama "Kelas"
    const colIndex = data.getNumberOfColumns();
    let idxKelas = -1;

    for (let i = 0; i < colIndex; i++) {
        if (data.getColumnLabel(i).toLowerCase() === "kelas") {
            idxKelas = i;
            break;
        }
    }

    if (idxKelas === -1) return alert("Kolom 'Kelas' tidak ditemukan!");

    for (let i = 0; i < data.getNumberOfRows(); i++) {
        kelasSet.add(data.getValue(i, idxKelas));
    }

    [...kelasSet].sort().forEach(k => {
        pilih.innerHTML += `<option value="${k}">${k}</option>`;
    });
}

function tampilkanTabel(data) {
    const table = new google.visualization.Table(document.getElementById('tableDiv'));
    table.draw(data);

    document.getElementById("downloadArea").style.display = "block";
}

function filterKelas() {
    const pilih = document.getElementById("pilihKelas").value;

    if (pilih === "ALL") {
        tampilkanTabel(globalData);
        return;
    }

    const view = new google.visualization.DataView(globalData);
    const colIndex = globalData.getNumberOfColumns();
    let idxKelas = -1;

    for (let i = 0; i < colIndex; i++) {
        if (globalData.getColumnLabel(i).toLowerCase() === "kelas") {
            idxKelas = i;
            break;
        }
    }

    view.setRows(
        globalData.getFilteredRows([{column: idxKelas, value: pilih}])
    );

    tampilkanTabel(view);
}

function downloadExcel() {
    window.open(`https://docs.google.com/spreadsheets/d/${sheetID}/export?format=xlsx`);
}

function downloadPDF() {
    window.open(`https://docs.google.com/spreadsheets/d/${sheetID}/export?format=pdf`);
}
</script>

</body>
</html>
