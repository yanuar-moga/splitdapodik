<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rekap Nilai Siswa</title>
<style>
body { font-family: Arial; padding:20px; background:#f4f4f4; }
h2 { margin-bottom:10px; }
select, input[type=number], button { padding:6px 10px; margin:5px; }
table { border-collapse: collapse; width:100%; margin-top:15px; background:white; }
th, td { border:1px solid #ccc; padding:6px; text-align:center; }
th { background:#333; color:white; }
.hijau { background:#d4edda; }
.kuning { background:#fff3cd; }
.merah { background:#f8d7da; }
.panel { background:white; padding:10px; border-radius:6px; border:1px solid #ddd; margin-bottom:15px; }
</style>
</head>
<body>

<h2>ðŸ“Š Rekap Nilai Siswa</h2>

<div class="panel">
<label><b>KKM:</b></label>
<input type="number" id="kkm" value="78" style="width:80px;">
<label><b>Pilih Kelas:</b></label>
<select id="kelasSelect"></select>
<br>
<label><b>Pilih Asesmen:</b></label>
<select id="asesmenSelect"></select>
<button onclick="loadData()">ðŸ”„ Muat Data</button>
</div>

<div id="output">Silakan pilih kelas dan asesmen, lalu muat data...</div>

<div id="downloadArea" style="margin-top:20px; display:none;">
<button onclick="downloadExcel()">ðŸ“¥ Download Excel</button>
<button onclick="downloadPDF()">ðŸ“¥ Download PDF</button>
</div>

<script>
// ======= KONFIGURASI =======
const gidPerKelas = {
  "7A": "195602539",
  "7B": "614617083",
  "7C": "1707869176",
  "7D": "865615390",
  "7E": "1458266317",
  "7F": "439382566",
  "7G": "936746401",
  "7H": "135762184",
  "7I": "304301086"
};

const asesmenPerGid = {
  "Asesmen Bab 3": "761163956",
  "Asesmen Bab 4": "1943120001",
  "Asesmen Bab 5": "1529993762"
};

// Populate dropdown kelas
const kelasSelect = document.getElementById("kelasSelect");
Object.keys(gidPerKelas).forEach(k => {
  const option = document.createElement("option");
  option.value = k;
  option.text = k;
  kelasSelect.appendChild(option);
});

// Populate dropdown asesmen
const asesmenSelect = document.getElementById("asesmenSelect");
Object.keys(asesmenPerGid).forEach(a => {
  const option = document.createElement("option");
  option.value = asesmenPerGid[a];
  option.text = a;
  asesmenSelect.appendChild(option);
});

// ======= Parser CSV Aman =======
function parseCSV(text){
  const lines = text.trim().split("\n");
  return lines.map(line => {
    const row = [];
    let cur = "";
    let inQuotes = false;
    for(let i=0;i<line.length;i++){
      const ch = line[i];
      if(ch === '"') inQuotes = !inQuotes;
      else if(ch === ',' && !inQuotes){
        row.push(cur);
        cur = "";
      } else {
        cur += ch;
      }
    }
    row.push(cur);
    return row;
  });
}

// ======= Load CSV =======
async function loadCSV(url){
  const res = await fetch(url);
  const text = await res.text();
  return parseCSV(text);
}

// ======= Load Data =======
async function loadData(){
  const kkm = parseInt(document.getElementById("kkm").value);
  const kelasTerpilih = kelasSelect.value;
  const gidAsesmen = asesmenSelect.value;

  if(!kelasTerpilih){ alert("Pilih kelas dulu!"); return; }
  if(!gidAsesmen){ alert("Pilih asesmen dulu!"); return; }

  document.getElementById("output").innerHTML = "Memuat data kelas "+kelasTerpilih+"â€¦";

  const LINK_SISWA_CSV = `https://docs.google.com/spreadsheets/d/1MBi121FQdTBVn3ovjnGPTFg0EplEGlHD/export?format=csv&gid=${gidPerKelas[kelasTerpilih]}`;
  const LINK_RESPONS_CSV = `https://docs.google.com/spreadsheets/d/1MBi121FQdTBVn3ovjnGPTFg0EplEGlHD/export?format=csv&gid=${gidAsesmen}`;

  // Ambil data siswa
  let siswa = await loadCSV(LINK_SISWA_CSV);
  siswa.shift(); // hapus header
  let dataSiswa = siswa.map(r => ({ no:r[0], nama:r[1].trim(), scoreAkhir:"", riwayat:[] }));

  // Ambil respons form
  let respons = await loadCSV(LINK_RESPONS_CSV);
  respons.shift(); // hapus header

  respons.forEach(r=>{
    let rawScore = r[1]?.trim(); // Kolom B = Score
    let rawNama  = r[2]?.trim(); // Kolom C = Nama

    if(rawScore && rawScore.includes("/")) rawScore = rawScore.split("/")[0].trim();

    const score = parseInt(rawScore);
    const nama  = rawNama;

    if(!nama || isNaN(score)) return;

    let target = dataSiswa.find(s => s.nama.toLowerCase() === nama.toLowerCase());
    if(target) target.riwayat.push(score);
  });

  // Hitung Score Akhir
  dataSiswa.forEach(s=>{
    if(s.riwayat.length>0) s.scoreAkhir = s.riwayat[s.riwayat.length-1];
  });

  // ======= Bangun tabel =======
  let html = `<h3>Data Kelas: ${kelasTerpilih}</h3>`;
  html += "<table><tr><th>No</th><th>Nama Siswa</th><th>Score Akhir</th>";
  let maxRiwayat = Math.max(...dataSiswa.map(s=>s.riwayat.length));
  for(let i=1;i<=maxRiwayat;i++){ html += `<th>Score ${i}</th>`; }
  html += "</tr>";

  dataSiswa.forEach(s=>{
    html += "<tr>";
    html += `<td>${s.no}</td>`;
    html += `<td>${s.nama}</td>`;
    let akhirClass = s.scoreAkhir === "" ? "" : (s.scoreAkhir>kkm ? "hijau": s.scoreAkhir==kkm?"kuning":"merah");
    html += `<td class="${akhirClass}">${s.scoreAkhir}</td>`;

    for(let i=0;i<maxRiwayat;i++){
      let nilai = s.riwayat[i] ?? "";
      let cls = nilai === "" ? "" : (nilai>kkm?"hijau":nilai==kkm?"kuning":"merah");
      html += `<td class="${cls}">${nilai}</td>`;
    }
    html += "</tr>";
  });

  html += "</table>";
  document.getElementById("output").innerHTML = html;
  document.getElementById("downloadArea").style.display="block";
}

// ======= Download =======
function downloadExcel(){
  const kelasTerpilih = kelasSelect.value;
  const gidSiswa = gidPerKelas[kelasTerpilih];
  window.open(`https://docs.google.com/spreadsheets/d/1MBi121FQdTBVn3ovjnGPTFg0EplEGlHD/export?format=xlsx&gid=${gidSiswa}`);
}

function downloadPDF(){
  const kelasTerpilih = kelasSelect.value;
  const gidSiswa = gidPerKelas[kelasTerpilih];
  window.open(`https://docs.google.com/spreadsheets/d/1MBi121FQdTBVn3ovjnGPTFg0EplEGlHD/export?format=pdf&gid=${gidSiswa}`);
}
</script>

</body>
</html>
