<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Rekap Nilai Siswa</title>
<style>
body { font-family: Arial; padding:20px; background:#f4f4f4; }
h2 { margin-bottom:10px; }
select, input[type=number], button { padding:6px 10px; margin:5px; }
table { border-collapse: collapse; width:100%; margin-top:15px; background:white; }
th, td { border:1px solid #ccc; padding:6px; text-align:center; }
th { background:#333; color:white; }
.hijau { background:#d4edda; }
.kuning { background:#fff3cd; }
.merah { background:#f8d7da; }
.panel { background:white; padding:10px; border-radius:6px; border:1px solid #ddd; margin-bottom:15px; }
</style>
</head>
<body>

<h2>ðŸ“Š Rekap Nilai Siswa</h2>

<div class="panel">
<label><b>KKM:</b></label>
<input type="number" id="kkm" value="78" style="width:80px;">
<label><b>Pilih Kelas:</b></label>
<select id="kelasSelect"></select>
<button onclick="loadData()">ðŸ”„ Muat Data</button>
</div>

<div id="output">Silakan pilih kelas dan muat data...</div>

<div id="downloadArea" style="margin-top:20px; display:none;">
<button onclick="downloadExcel()">ðŸ“¥ Download Excel</button>
<button onclick="downloadPDF()">ðŸ“¥ Download PDF</button>
</div>

<script>
// ======= KONFIGURASI GOOGLE SHEET =======
const LINK_SISWA_CSV = "https://docs.google.com/spreadsheets/d/1MBi121FQdTBVn3ovjnGPTFg0EplEGlHD/export?format=csv&gid=195602539";
const LINK_RESPONS_CSV = "https://docs.google.com/spreadsheets/d/1MBi121FQdTBVn3ovjnGPTFg0EplEGlHD/export?format=csv&gid=1943120001";

// ======= LIST KELAS (JSON STATIS) =======
const daftarKelas = ["7A","7B","7C","7D","7E","7F","7G","7H","7I",
                     "8A","8B","8C","8D","8E","8F","8G","8H","8I",
                     "9A","9B","9C","9D","9E","9F","9G","9H","9I"];

const kelasSelect = document.getElementById("kelasSelect");

// Populate dropdown kelas
daftarKelas.forEach(k => {
    const option = document.createElement("option");
    option.value = k;
    option.text = k;
    kelasSelect.appendChild(option);
});

// ======= FUNGSI UTAMA =======
async function loadCSV(url){
    const res = await fetch(url);
    const txt = await res.text();
    return txt.trim().split("\n").map(r => r.split(","));
}

async function loadData(){
    const kkm = parseInt(document.getElementById("kkm").value);
    const kelasTerpilih = kelasSelect.value;
    if(!kelasTerpilih){ alert("Pilih kelas dulu!"); return; }

    document.getElementById("output").innerHTML = "Memuat data kelas "+kelasTerpilih+"â€¦";

    // --- Ambil daftar siswa ---
    let siswa = await loadCSV(LINK_SISWA_CSV);
    siswa.shift(); // hapus header

    // Filter sesuai kelas
    let dataSiswa = siswa.filter(r => r[2]?.trim() === kelasTerpilih) // asumsikan kolom C = kelas
        .map(r => ({ no:r[0], nama:r[1].trim(), scoreAkhir:"", riwayat:[] }));

    // --- Ambil respons form ---
    let respons = await loadCSV(LINK_RESPONS_CSV);
    respons.shift(); // hapus header

    // Format: Nilai kolom B (1), Nama kolom C (2)
    respons.forEach(r=>{
        const score = parseInt(r[1]);
        const nama = r[2]?.trim();
        if(!nama || isNaN(score)) return;

        let target = dataSiswa.find(s=>s.nama.toLowerCase()===nama.toLowerCase());
        if(target) target.riwayat.push(score);
    });

    // Score akhir = nilai terakhir
    dataSiswa.forEach(s=>{
        if(s.riwayat.length>0) s.scoreAkhir = s.riwayat[s.riwayat.length-1];
    });

    // ======= BANGUN TABEL =======
    let html = "<table><tr>";
    html += "<th>No</th><th>Nama Siswa</th><th>Score Akhir</th>";
    let maxRiwayat = Math.max(...dataSiswa.map(s=>s.riwayat.length));
    for(let i=1;i<=maxRiwayat;i++){ html += `<th>Score ${i}</th>`; }
    html += "</tr>";

    dataSiswa.forEach(s=>{
        html += "<tr>";
        html += `<td>${s.no}</td>`;
        html += `<td>${s.nama}</td>`;

        let akhirClass = s.scoreAkhir === "" ? "" : (s.scoreAkhir>kkm ? "hijau": s.scoreAkhir==kkm?"kuning":"merah");
        html += `<td class="${akhirClass}">${s.scoreAkhir}</td>`;

        for(let i=0;i<maxRiwayat;i++){
            let nilai = s.riwayat[i] ?? "";
            let cls = nilai === "" ? "" : (nilai>kkm?"hijau":nilai==kkm?"kuning":"merah");
            html += `<td class="${cls}">${nilai}</td>`;
        }

        html += "</tr>";
    });

    html += "</table>";
    document.getElementById("output").innerHTML = html;
    document.getElementById("downloadArea").style.display="block";
}

// ======= DOWNLOAD =======
function downloadExcel(){
    window.open(`https://docs.google.com/spreadsheets/d/1MBi121FQdTBVn3ovjnGPTFg0EplEGlHD/export?format=xlsx`);
}
function downloadPDF(){
    window.open(`https://docs.google.com/spreadsheets/d/1MBi121FQdTBVn3ovjnGPTFg0EplEGlHD/export?format=pdf`);
}
</script>

</body>
</html>
