<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rekap Nilai Siswa</title>
<style>
body { font-family: Arial; padding:20px; background:#f4f4f4; }
h2 { margin-bottom:10px; }
select, input[type=number], button { padding:6px 10px; margin:5px; }
table { border-collapse: collapse; width:100%; margin-top:15px; background:white; }
th, td { border:1px solid #ccc; padding:6px; text-align:center; }
th { background:#333; color:white; }
.hijau { background:#d4edda; }
.kuning { background:#fff3cd; }
.merah { background:#f8d7da; }
.panel { background:white; padding:10px; border-radius:6px; border:1px solid #ddd; margin-bottom:15px; }
</style>
</head>
<body>

<h2>üìä Rekap Nilai Siswa</h2>

<div class="panel">
<label><b>KKM:</b></label>
<input type="number" id="kkm" value="78" style="width:80px;">
<label><b>Pilih Kelas:</b></label>
<select id="kelasSelect"></select>
<br>
<label><b>Pilih Asesmen:</b></label>
<select id="asesmenSelect"></select>
<button onclick="loadData()">üîÑ Muat Data</button>
</div>

<div id="output">Silakan pilih kelas dan asesmen, lalu muat data...</div>

<script>
// ===== CONFIG =====
const gidPerKelas = {
  "7A": "195602539",
  "7B": "614617083",
  "7C": "1707869176",
  "7D": "865615390",
  "7E": "1458266317",
  "7F": "439382566",
  "7G": "936746401",
  "7H": "135762184",
  "7I": "304301086"
};

const asesmenPerGid = {
  "Asesmen Bab 3": "761163956",
  "Asesmen Bab 4": "562158054",
  "Asesmen Bab 5": "1529993762"
};

// Apps Script Web App URL
const proxyURL = "https://script.google.com/macros/s/AKfycbwZ5IBqbWAEJoxqqbT2_AHvkxfaXxzh7_VVo_4iGElrmQKXRHpQiXXQ3WOFUdyj4Nooyw/exec"; // ganti dengan web app URL Anda

// Dropdown populate
const kelasSelect = document.getElementById("kelasSelect");
Object.keys(gidPerKelas).forEach(k => {
  const option = document.createElement("option");
  option.value = k;
  option.text = k;
  kelasSelect.appendChild(option);
});

const asesmenSelect = document.getElementById("asesmenSelect");
Object.keys(asesmenPerGid).forEach(a => {
  const option = document.createElement("option");
  option.value = asesmenPerGid[a];
  option.text = a;
  asesmenSelect.appendChild(option);
});

// ===== Load Siswa =====
async function loadCSV(url){
  const res = await fetch(url);
  const text = await res.text();
  const lines = text.trim().split("\n");
  return lines.map(l => l.split(","));
}

// ===== Load Data =====
async function loadData(){
  const kkm = parseInt(document.getElementById("kkm").value);
  const kelasTerpilih = kelasSelect.value;
  const asesmenGid = asesmenSelect.value;

  if(!kelasTerpilih || !asesmenGid) { alert("Pilih kelas & asesmen!"); return; }
  document.getElementById("output").innerHTML = "Memuat data‚Ä¶";

  // 1Ô∏è‚É£ Ambil data siswa dari sheet publik
  const LINK_SISWA_CSV = `https://docs.google.com/spreadsheets/d/1MBi121FQdTBVn3ovjnGPTFg0EplEGlHD/export?format=csv&gid=${gidPerKelas[kelasTerpilih]}`;
  let siswa = await loadCSV(LINK_SISWA_CSV);
  siswa.shift(); // hapus header
  let dataSiswa = siswa.map(r=>({no:r[0], nama:r[1].trim(), scoreAkhir:"", riwayat:[]}));

  // 2Ô∏è‚É£ Ambil data score via Apps Script Proxy
  const sheetId = "1MBi121FQdTBVn3ovjnGPTFg0EplEGlHD"; // ganti jika beda sheet
  const resp = await fetch(`${proxyURL}?sheetId=${sheetId}&gid=${asesmenGid}`);
  const jsonData = await resp.json();

  // 3Ô∏è‚É£ Cocokkan nama dan score
  jsonData.forEach(r=>{
    let nama = (r["nama"]||"").trim();
    let rawScore = (r["score"]||"").trim();
    if(rawScore.includes("/")) rawScore = rawScore.split("/")[0].trim();
    const score = parseInt(rawScore);
    if(!nama || isNaN(score)) return;
    let target = dataSiswa.find(s => s.nama.toLowerCase() === nama.toLowerCase());
    if(target) target.riwayat.push(score);
  });

  // 4Ô∏è‚É£ Hitung Score Akhir
  dataSiswa.forEach(s=>{
    if(s.riwayat.length>0) s.scoreAkhir = s.riwayat[s.riwayat.length-1];
  });

  // 5Ô∏è‚É£ Buat tabel
  let html = `<h3>Data Kelas: ${kelasTerpilih}</h3>`;
  html += "<table><tr><th>No</th><th>Nama Siswa</th><th>Score Akhir</th>";
  let maxRiwayat = Math.max(...dataSiswa.map(s=>s.riwayat.length));
  for(let i=1;i<=maxRiwayat;i++) html += `<th>Score ${i}</th>`;
  html += "</tr>";

  dataSiswa.forEach(s=>{
    html += "<tr>";
    html += `<td>${s.no}</td>`;
    html += `<td>${s.nama}</td>`;
    let cls = s.scoreAkhir === "" ? "" : (s.scoreAkhir>kkm?"hijau":s.scoreAkhir==kkm?"kuning":"merah");
    html += `<td class="${cls}">${s.scoreAkhir}</td>`;
    for(let i=0;i<maxRiwayat;i++){
      let n = s.riwayat[i] ?? "";
      let cls2 = n === "" ? "" : (n>kkm?"hijau":n==kkm?"kuning":"merah");
      html += `<td class="${cls2}">${n}</td>`;
    }
    html += "</tr>";
  });

  html += "</table>";
  document.getElementById("output").innerHTML = html;
}
</script>
</body>
</html>
