<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rekap Perbaikan Nilai Siswa</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #f4f6f8;
      margin: 0;
      padding: 20px;
      color: #333;
    }
    .app-header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 20px;
    }
    .app-header img {
      width: 60px;
      height: 60px;
      border-radius: 10px;
    }
    h1 {
      margin: 0;
      font-size: 1.6em;
      color: #0078d7;
    }
    h2 {
      margin-top: 30px;
      color: #444;
    }
    input, select, button {
      font-size: 1em;
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
      margin: 5px 0;
    }
    button {
      background: #0078d7;
      color: white;
      cursor: pointer;
      transition: 0.3s;
    }
    button:hover {
      background: #005fa3;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: white;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }
    th {
      background: #0078d7;
      color: white;
      position: sticky;
      top: 0;
    }
    .highlight-empty { background: #fff3cd; }
    .highlight-low { background: #f8d7da; }
    #outputText {
      width: 100%;
      height: 200px;
      margin-top: 10px;
      padding: 10px;
      font-size: 1em;
    }
  </style>
</head>
<body>

  <div class="app-header">
    <img src="assets/logo.jpg" alt="Logo Sekolah">
    <div>
      <h1>Rekap Perbaikan Nilai Siswa</h1>
      <small>Versi 1.0 (Build 13 November 2025) | Develop by MB</small>
    </div>
  </div>

  <h2>1Ô∏è‚É£ Muat File Excel / CSV</h2>
  <input type="file" id="fileInput" accept=".xlsx,.xlsm,.csv">
  <select id="sheetSelect" style="display:none;"></select>
  <br>
  <label>KKM: </label>
  <input type="number" id="kkmInput" value="78" min="0" max="100">

  <h2>2Ô∏è‚É£ Pilih TP yang Ingin Ditampilkan</h2>
  <div id="tpOptions"></div>
  <button onclick="checkAllTP()">Ceklis Semua TP</button>
  <button onclick="uncheckAllTP()">Unceklis Semua TP</button>
  <button onclick="checkTP1()">Ceklis TP1 Saja</button>
  <button onclick="checkTP1TP2()">Ceklis TP1 dan TP2</button>

  <h2>3Ô∏è‚É£ Tampilkan Data</h2>
  <button onclick="showFilteredData()">Tampilkan Data</button>
  <button onclick="exportExcel()">Download Excel</button>
  <button onclick="copyText()">Copy ke Clipboard</button>

  <div id="tableContainer"></div>
  <textarea id="outputText" readonly></textarea>

  <script>
    let workbook, selectedSheet;
    const tpNames = [
      "BAB 1 TP 1","BAB 1 TP 2","BAB 1 TP 3","BAB 1 TP 4",
      "BAB 2 TP 1","BAB 2 TP 2","BAB 2 TP 3","BAB 2 TP 4",
      "BAB 3 TP 1","BAB 3 TP 2","BAB 3 TP 3","BAB 3 TP 4",
      "BAB 4 TP 1","BAB 4 TP 2","BAB 4 TP 3","BAB 4 TP 4",
      "BAB 5 TP 1","BAB 5 TP 2","BAB 5 TP 3","BAB 5 TP 4"
    ];

    // generate checkbox TP per BAB
    const tpContainer = document.getElementById('tpOptions');
    let currentBAB = '';
    tpNames.forEach(tp => {
      const bab = tp.split(' ')[1];
      if (bab !== currentBAB) {
        tpContainer.appendChild(document.createElement('br'));
        const labelBAB = document.createElement('b');
        labelBAB.innerText = "üü¶ " + tp.split(' ')[0] + " " + bab;
        tpContainer.appendChild(labelBAB);
        tpContainer.appendChild(document.createElement('br'));
        currentBAB = bab;
      }
      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.value = tp;
      cb.checked = true;
      const label = document.createElement('label');
      label.innerText = tp;
      label.style.marginRight = "15px";
      tpContainer.appendChild(cb);
      tpContainer.appendChild(label);
      tpContainer.appendChild(document.createElement('br'));
    });

    // handle file upload
    document.getElementById('fileInput').addEventListener('change', handleFile, false);
    function handleFile(e) {
      const file = e.target.files[0];
      const reader = new FileReader();
      reader.onload = (event) => {
        const data = new Uint8Array(event.target.result);
        workbook = XLSX.read(data, {type: 'array'});
        const sheetSelect = document.getElementById('sheetSelect');
        sheetSelect.innerHTML = '';
        workbook.SheetNames.forEach(name => {
          const option = document.createElement('option');
          option.text = name;
          sheetSelect.add(option);
        });
        sheetSelect.style.display = 'inline-block';
        sheetSelect.onchange = () => selectedSheet = sheetSelect.value;
        selectedSheet = workbook.SheetNames[0];
      };
      reader.readAsArrayBuffer(file);
    }

    function getSheetData() {
      const sheet = workbook.Sheets[selectedSheet];
      const range = XLSX.utils.decode_range(sheet['!ref']);
      const rows = [];
      for (let row = 9; row <= range.e.r; row++) {
        const nameCell = sheet[XLSX.utils.encode_cell({r: row, c: 1})];
        if (!nameCell || !nameCell.v) break; 
        const rowData = [nameCell.v];
        for (let c = 2; c <= 21; c++) {
          const cell = sheet[XLSX.utils.encode_cell({r: row, c})];
          rowData.push(cell ? cell.v : '');
        }
        rows.push(rowData);
      }
      return rows;
    }

    function showFilteredData() {
      if (!workbook) return alert("Harap muat file Excel terlebih dahulu!");
      const kkm = parseFloat(document.getElementById('kkmInput').value) || 78;
      const selectedTPs = Array.from(document.querySelectorAll('#tpOptions input:checked')).map(cb => cb.value);
      const rows = getSheetData();
      const container = document.getElementById('tableContainer');
      container.innerHTML = '';

      let html = `<table><tr><th>No</th><th>Nama</th>`;
      selectedTPs.forEach(tp => html += `<th>${tp}</th>`);
      html += `</tr>`;
      
      let textResult = "Berikut daftar siswa yang masih perlu perbaikan nilai:\n\n";
      const babLinks = {
        1:"https://look.short.gy/asesmen1",
        2:"https://look.short.gy/asesmen2",
        3:"https://look.short.gy/asesmen3",
        4:"https://look.short.gy/asesmen4",
        5:"https://look.short.gy/asesmen5"
      };
      const babUsed = new Set();

      rows.forEach((r, i) => {
        const name = r[0];
        let show = false;
        const nilai = {};
        selectedTPs.forEach((tp, j) => {
          nilai[tp] = r[j + 1];
          if (nilai[tp] === "" || parseFloat(nilai[tp]) < kkm) show = true;
        });
        if (show) {
          html += `<tr><td>${i + 1}</td><td>${name}</td>`;
          selectedTPs.forEach(tp => {
            const v = nilai[tp];
            let cls = '';
            if (v === '') cls = 'highlight-empty';
            else if (parseFloat(v) < kkm) cls = 'highlight-low';
            html += `<td class="${cls}">${v || ''}</td>`;
          });
          html += `</tr>`;
          const kosongTP = selectedTPs.filter(tp => nilai[tp] === '' || parseFloat(nilai[tp]) < kkm);
          kosongTP.forEach(tp => babUsed.add(tp.split(' ')[1]));
          textResult += `${name} ‚Üí ${kosongTP.join(', ')}\n`;
        }
      });
      html += `</table>`;
      container.innerHTML = html;

      if (babUsed.size > 0) {
        textResult += `\n`;
        babUsed.forEach(b => {
          textResult += `BAB ${b} link perbaikan ${babLinks[b]}\n`;
        });
      }

      document.getElementById('outputText').value = textResult;
    }

    function exportExcel() {
      const table = document.querySelector('table');
      if (!table) return alert("Tidak ada data untuk diekspor!");
      const ws = XLSX.utils.table_to_sheet(table);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Rekap Nilai");
      XLSX.writeFile(wb, `Rekap_Nilai_${selectedSheet}_Bermasalah.xlsx`);
    }

    function copyText() {
      const text = document.getElementById('outputText');
      text.select();
      document.execCommand('copy');
      alert('Teks telah disalin ke clipboard!');
    }

    function checkAllTP() { document.querySelectorAll('#tpOptions input').forEach(cb => cb.checked = true); }
    function uncheckAllTP() { document.querySelectorAll('#tpOptions input').forEach(cb => cb.checked = false); }
    function checkTP1() { 
      uncheckAllTP();
      document.querySelectorAll('#tpOptions input').forEach(cb => {
        if (cb.value.includes("TP 1")) cb.checked = true;
      });
    }
    function checkTP1TP2() { 
      uncheckAllTP();
      document.querySelectorAll('#tpOptions input').forEach(cb => {
        if (cb.value.includes("TP 1") || cb.value.includes("TP 2")) cb.checked = true;
      });
    }
  </script>

</body>
</html>
